services:
  n8n:
    image: n8nio/n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=localhost
      - WEBHOOK_URL=http://localhost:5678
    volumes:
      - n8n_data:/home/node/.n8n
    restart: unless-stopped

  fastapi_app:
    # Build from the current directory using uv
    build: .
    ports:
      - "8000:8000"
    restart: unless-stopped
    volumes:
      # Mount source code for hot reload during development
      - .:/app
      # Exclude common directories that shouldn't be mounted
      - /app/__pycache__
      - /app/.venv
      - /app/.git
    environment:
      # Ensure Python doesn't write bytecode to mounted volume
      - PYTHONDONTWRITEBYTECODE=1
      # Connect to Chrome running on macOS host via a local TCP forwarder:
      # host:9223 -> 127.0.0.1:9222
      #
      # IMPORTANT: Chrome rejects non-local Host headers (e.g. host.docker.internal).
      # Use an IP in the URL to avoid 500: "Host header is specified and is not an IP address or localhost."
      - PLAYWRIGHT_CDP_URL=http://${HOST_IP}:9223

volumes:
  n8n_data:
